# 变更提案: 运行时可观测性与诊断面板

## 需求背景

本项目是“纯静态 / 无框架 / Local-first / PWA 离线”的多页站点，已有本地埋点（`telemetry`）与工程自诊断（`GKB.health()`）能力，但当前仍存在一类“行业标准能力缺口”：

1. **错误边界缺失**：运行时异常/Promise 未处理拒绝多数只会落到控制台；用户侧缺少可理解的兜底提示与自助恢复指引。
2. **诊断闭环不足**：已有埋点与健康快照能力，但缺少可视化入口（查看/导出/清理），导致排障成本偏高。
3. **工程可观测性不够“可用”**：指标采集存在，但缺少“可被消费”的 UI 与结构化导出（便于在 Issue/PR 里复现与对齐）。

在不引入后端、不破坏现有静态交付与业务逻辑根基的前提下，需要补齐一套 **本地化、可控、可导出** 的可观测性模块，形成从“异常发生 → 记录 → 呈现 → 导出 → 清理”的闭环。

## 变更内容

1. 引入 **全局错误边界（Local Error Boundary）**：捕获 `error / unhandledrejection / securitypolicyviolation` 等关键异常并写入本地诊断日志（ring buffer）。
2. 提供 **系统诊断面板（Diagnostics Panel）**：
   - 可查看：最近错误、本地埋点事件、关键健康指标摘要
   - 可操作：一键导出诊断包、一键清空错误日志、开关本地埋点
3. 增强 **健康监控（Health Monitor）**：在不改变默认行为的前提下，扩展采集指标（例如 FCP / INP）并允许“静默快照”（避免在 UI 初始化时污染控制台）。
4. 将诊断能力以“增量扩展”的方式接入到现有体验入口（指挥舱 / Command Palette），确保不破坏现有页面结构与主流程。

## 影响范围

- **模块**
  - runtime（`scripts.js` / `styles.css` / `dashboard.html`）
  - docs（补充运行时与诊断使用说明）
  - helloagents 知识库（模块文档与变更记录）

- **文件**
  - `scripts.js`（新增 diagnostics 与错误边界、诊断面板入口）
  - `styles.css`（新增诊断面板样式，复用现有 Aurora/Glass token）
  - `dashboard.html`（新增“系统诊断”卡片区域）
  - `README.md`（补充诊断能力说明）
  - `helloagents/wiki/modules/runtime.md`（同步模块能力）
  - `helloagents/CHANGELOG.md`（记录本次变更）

## 核心场景

### 需求: 运行时异常兜底（错误边界）
**模块:** runtime

#### 场景: 页面执行抛出异常
- 用户在任意页面触发 JS 异常（包括第三方浏览器扩展干扰、缓存版本不一致等）
- 预期结果：
  - 页面不必“完全崩溃”，至少提示用户发生异常
  - 异常被记录到本地诊断日志（可导出）

#### 场景: Promise 未处理拒绝
- 预期结果：
  - 记录到本地诊断日志
  - 给予用户可执行的恢复建议（刷新/清缓存/关闭离线包等）

### 需求: 诊断面板与导出
**模块:** runtime

#### 场景: 用户/贡献者需要快速自检
- 预期结果：
  - 在指挥舱或 Command Palette 中可打开诊断面板
  - 可一键导出诊断包（JSON），便于提交 Issue/PR
  - 可清空错误日志与切换本地埋点开关

## 风险评估

- **风险:** 诊断信息包含隐私数据（PII）
  - **缓解:** 严格本地存储、不外发；字段白名单 + 截断；仅保留技术信息（时间戳/页面/错误摘要/指标）
- **风险:** 诊断功能影响性能（额外监听/写 localStorage）
  - **缓解:** ring buffer 限量；写入失败静默降级；UI 按需渲染；toast 节流

