# 变更提案: UI Evolution v5（设置中心 + Planner 日历导出）

## 需求背景

GameKnowledge-Base 已具备 Pixel UI（EVO-VIS v4.x）、本地状态闭环与 PWA 离线能力，但随着功能扩展：

1. **用户偏好维度变多**：主题/高对比度已存在，但“强调色/密度/动效/透明度”等偏好缺少统一入口与统一持久化策略，导致体验分散（需要记忆快捷键/分散在不同页面）。
2. **路线规划的落地链路不完整**：Planner 能生成冲刺节奏与可复制摘要，但缺少与日历工具协同的“最后一公里”（例如导出到 iOS/Google/Outlook 日历）。
3. **视觉系统持续演进**：当前 `styles.css` 采用“末尾覆盖”补丁策略快速迭代，长期会增加风格漂移与维护成本；需要在不破坏既有交互/门禁的前提下，进一步收敛关键 token 与状态开关。

本变更以“**不引入框架、不依赖外链、不破坏离线与门禁**”为硬约束，升级为更统一、更可控、可回归的 v5 体验层。

## 产品分析

### 目标用户与场景

- **用户群体**
  - 轻度玩家：希望快速找攻略、减少干扰、提升可读性。
  - 深度玩家：关注路线规划、进度管理、跨设备备份与工具协同。
  - 弱网/离线用户：依赖 PWA 离线与本地状态闭环，对“稳定、可用”优先。

- **使用场景**
  - 夜间阅读攻略，需要更柔和的主题与更舒适/更紧凑的阅读密度。
  - 在通勤/碎片时间做冲刺推进，希望把“冲刺节奏”同步进日历提醒。
  - 低性能设备或偏好极简的用户，希望一键降低动效/透明度提升流畅度。

- **核心痛点**
  - 设置入口分散：功能虽强，但缺少“一个地方管所有偏好”的统一感。
  - Planner 输出无法被外部工具直接消费，路线从“站内计划”到“日常执行”断档。
  - 视觉系统补丁式演进容易出现“同类组件手感不一致”的隐性回归风险。

### 价值主张与成功指标

- **价值主张**
  - “所有偏好一个面板解决”：主题/对比度/强调色/密度/动效/透明度统一管理，所见即所得。
  - “路线能真正进入日程”：Planner 一键导出 `.ics` 日历文件，把冲刺节奏落到用户的真实时间表。
  - “视觉系统更收敛、更稳定”：关键 token 与状态开关可回归，减少风格漂移与维护成本。

- **成功指标**
  - 设置中心可在任意页面打开，且改动即时生效并持久化（刷新不丢）。
  - Planner 导出的 `.ics` 可被主流日历应用导入（至少 iOS/Google/Outlook）。
  - `npm run check:all` 全量门禁通过（含 bundle size 预算），无新增外链/无 CSP 违规。

### 人文关怀

- **包容性与可访问性**：高对比度/Reduced Motion 必须可降级且不影响信息层级。
- **隐私**：所有偏好与导出数据仅在本地浏览器处理，不引入任何外发链路。

## 变更内容

1. 新增“设置中心”（Settings Center）：统一管理主题/对比度/强调色/密度/动效/透明度，并提供关键动作入口（离线更新检查/本地数据管理等）。
2. Planner 新增 `.ics` 日历导出：基于冲刺节奏生成日历事件，支持自定义开始日期/时间，并持久化到 `gkb-plan-settings`。
3. 视觉系统 v5 收敛：补齐并收敛关键 token，新增与设置中心一致的状态开关（accent/density/motion/transparency），确保暗色/高对比度一致性。

## 影响范围

- **模块**
  - runtime（样式、交互、离线、本地状态）

- **文件**
  - `boot.js`（首帧偏好注入：theme/contrast + 新增偏好）
  - `scripts.js`（设置中心、Planner 日历导出、偏好状态闭环）
  - `styles.css`（v5 token 与状态开关、组件统一）
  - `planner.html`（新增导出控件与可访问性）
  - `dashboard.html`（设置入口与状态展示增强）
  - `docs/STYLE_GUIDE.md`（新增偏好 key 与 UI 约定）
  - `helloagents/wiki/modules/runtime.md`（同步运行时能力说明）

## 核心场景

### 需求: 全局设置中心
**模块:** runtime

#### 场景: 任意页面快速调整偏好
- 用户在任意页面打开设置中心
- 切换主题/高对比度/强调色/密度/动效/透明度后立即生效
- 刷新页面后偏好仍保持一致

### 需求: Planner 日历导出
**模块:** runtime

#### 场景: 冲刺节奏导入到日历
- 用户在 Planner 生成冲刺节奏
- 设置开始日期/时间并一键导出 `.ics`
- 在日历应用导入后可看到冲刺 1..N 的事件，描述包含条目清单

## 风险评估

- **风险:** 新增偏好 key 与 dataset 可能与旧逻辑冲突  
  **缓解:** 以“可选字段 + 默认值”方式扩展；优先尊重现有 theme/contrast 行为；对旧数据做兼容读取。
- **风险:** 视觉 token 调整导致暗色/高对比度对比度下降  
  **缓解:** 保持 `data-contrast="high"` 为可读性优先；在 CSS 中对高对比度关闭易干扰的玻璃与动态边框。
- **风险:** `.ics` 生成在不同时区/日历客户端兼容性差  
  **缓解:** 采用标准 VCALENDAR + 事件字段（UID/DTSTAMP/DTSTART/DTEND/DESCRIPTION），并实现基础折行与字符转义；默认“本地浮动时间”策略减少时区依赖。

